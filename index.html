<html>

<head>
	<link rel="icon" type="image/png" href="/favicon.png"/>
	<script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
</head>

<body>
	<script>
		"use strict";
		// register components
		// examples
		AFRAME.registerComponent('hello-world', {
			schema: {
				message: { type: 'string', default: 'World' }
			},
			init: function () {
				// Closure to access fresh `this.data` from event handler context.
				var _this = this;

				// .init() is a good place to set up initial state and variables.
				// Store a reference to the handler so we can later remove it.
				this.eventHandlerFn = function () { console.log(_this.data.message); };
			},
			update: function (oldData) {
				var data = this.data;
				var el = this.el;

				if (data.event) {
					el.addEventListener(data.event, this.eventHandlerFn);
				} else {
					console.log(data.message);
				}
			}
		});
		AFRAME.registerComponent('basic-click-handler', {
			//dependencies: ['raycaster'],
			init: function () {
				console.log('initializing basic-click-handler');
				var el = this.el;
				el.addEventListener('click', event => {
					console.log('Youpi!!!!');
				});
			}
		});
		// ====
		AFRAME.registerComponent('portfolio-manager', {
			schema: {
				step: { type: 'number', default: 0 }
			},
			init: function() {
				const startStep = this.data.step;
				
				this.data.__stepHolder = document.getElementById("stepHolder");

				this._loadStep(startStep);
			},
			_entities: {
				startButton: function() {
					const buttongltf = this._createCustomEntity("a-entity", {
						["gltf-model"]: "#bubbleOrange",
						["start-button"]: "",
						button: ""
					});
					const text = this._createCustomEntity("a-text", {
						font: "assets/font/Gidole-Regular-msdf/Gidole-Regular-msdf.json",
						color: "#48220d",
						align: "center",
						position: "0 0.02 0.08",
						scale: "0.6 0.6 0.6",
						negate: "false",
						value: "Start"
					})
					buttongltf.appendChild(text);
					return buttongltf;
				},
				introText: function() {
					const aText = this._createCustomEntity("a-text", {
						font: "assets/font/Gidole-Regular-msdf/Gidole-Regular-msdf.json",
						align: "left",
						baseline: "top",
						negate: "false",
						color: "#462a19",
						["wrap-count"]: "40",
						value: document.getElementById("introtext").innerHTML,
						["text-reveal"]: "characterDelay: 75;"
					});
					return aText;
				},
				smartphone: function() {
					const phone = this._createCustomEntity("a-entity", {
						["gltf-model"]: "#smartphone",
					});
					return phone;
				},
				steeringWheel: function() {
					const steeringWheel = this._createCustomEntity("a-entity", {
						["gltf-model"]: "#steeringwheel"
					})
					return steeringWheel;
				}
			},
			_loadStep: function(step) {
				const currentStep = (function(step) {
					switch (step) {
					case -1:
						var steeringWheel = this._entities.steeringWheel.call(this);
						steeringWheel.setAttribute("scale", "3 3 3");
						steeringWheel.setAttribute("mixin", "turntable");
						return steeringWheel
					case 0:
						var startButton = this._entities.startButton.call(this);
						startButton.addEventListener("destroyed", (function() {
							this._loadStep(step + 1);
						}).bind(this));

						return startButton;
					case 1:
						const holder = this._createCustomEntity.call(this, "a-entity");

						const introText = this._entities.introText.call(this);
						introText.addEventListener("destroyed", (function() {
							this._loadStep(step + 1);
						}).bind(this));
						introText.setAttribute("position", "-1.07675 0.76176 0");

						const textPivot = this._createCustomEntity.call(this, "a-entity");
						textPivot.appendChild(introText);
						introText.addEventListener("endreveal", event => {
							setTimeout(() => {
								textPivot.setAttribute("animation__slide_up", "property: position; to: 0 2 0; dur: 1200; easing: easeInQuart;");
								textPivot.setAttribute("animation__tilt_up", "property: rotation; to: -90 0 0; dur: 1200; easing: easeInExpo;")
								textPivot.addEventListener("animationcomplete", event => {
									if (event.detail.name == "animation__slide_up") {
										textPivot.dispatchEvent(new Event("endslideup"));
										textPivot.parentNode.removeChild(textPivot);
									}
								});
							}, 1300);
						});
						
						const smartphone = this._entities.smartphone.call(this);
						smartphone.setAttribute("scale", "5 5 5");
						
						const phonePivot = this._createCustomEntity.call(this, "a-entity");
						phonePivot.appendChild(smartphone);
						phonePivot.setAttribute("visible", "false");
						//  TODO: make phone appear after text disapears
						textPivot.addEventListener("endslideup", event => {
							phonePivot.setAttribute("visible", "true");
							phonePivot.setAttribute("animation__slide_up", "property: position; to: 0 0 0; dur: 1200; easing: easeOutQuart;");
							phonePivot.setAttribute("animation__tilt_up", "property: rotation; to: 0 0 0; dur: 1200; easing: easeOutExpo;")
							phonePivot.addEventListener("animationcomplete", event => {
								if (event.detail.name == "animation__tilt_up") {	
									phonePivot.setAttribute("animation__scale_back", "property: scale; to: 2 2 2; dur: 800; easing: easeOutBack;");
								}
							});
						});
						phonePivot.setAttribute("position", "0 -2 0");
						phonePivot.setAttribute("rotation", "90 0 0");
						
						holder.appendChild(textPivot);
						holder.appendChild(phonePivot);
						
						return holder;
					};
				}).bind(this)(step)
				this.data.__stepHolder.appendChild(currentStep);
			},
			_createCustomEntity: function(entity, attributes) {
				const newEntity = document.createElement(entity);
				for (const [key, value] of Object.entries(attributes || {})) {
					newEntity.setAttribute(key, value);
				}
				return newEntity;
			},
		});
		AFRAME.registerComponent('start-button', {
			init: function () {
				var el = this.el;
				el.addEventListener("animationcomplete", event => {
					if (event.detail.name === "animation__appear_bounce_scale") {
						el.removeAttribute("animation__appear_bounce_scale");
						el.addEventListener("click", event => {
							el.removeAttribute("animation__wave_down");
							el.removeAttribute("animation__wave_up");
							el.setAttribute("animation__spin", "property: rotation; to: 0 360 0; dur: 1600; easing: easeOutElastic; elasticity: 12;")
							el.setAttribute("animation__unscale", "property: scale; to: 0 0 0; delay: 1000; dur: 600; easing: easeInExpo;")
						});
						el.setAttribute("animation__wave_up", "property: position; to: 0 0.06 0; dur: 1200; easing: easeInOutQuad;");
					}
					if (event.detail.name === "animation__wave_down") {
						el.removeAttribute("animation__wave_down");
						el.setAttribute("animation__wave_up", "property: position; to: 0 0.06 0; dur: 1200; easing: easeInOutQuad;");
					}
					else if (event.detail.name === "animation__wave_up") {
						el.removeAttribute("animation__wave_up");
						el.setAttribute("animation__wave_down", "property: position; to: 0 -0.06 0; dur: 1200; easing: easeInOutQuad;");
					}
					else if (event.detail.name === "animation__unscale") {
						setTimeout(() => {
							el.dispatchEvent(new Event("destroyed"));
						}, 1000);
						el.parentNode.removeChild(el);
					}
				});
				el.setAttribute("mixin", "appearBounce");
			}
		});
		AFRAME.registerComponent("text-reveal", {
			dependencies: ["text"],
			schema: {
				characterDelay: { type: "number", default: 100 }
			},
			init: function() {
				var el = this.el;
				var textAttribute = el.getAttribute("text");
				this.data.__textValue = textAttribute.value;
				this.data.__textOffset = 0;
				textAttribute.value = "";
				el.setAttribute("text", textAttribute);
				this.data.__offsetTimeout = setInterval(() => { this.data.__textOffset += this.data.__textValue.charAt(this.data.__textOffset) == '\\' ? 2 : 1; }, this.data.characterDelay);
			},
			tick: function() {
				var el = this.el;
				var textAttribute = el.getAttribute("text");
				textAttribute.value = this.data.__textValue.substring(0, this.data.__textOffset);
				el.setAttribute("text", textAttribute);
				if (this.data.__textOffset == this.data.__textValue.length) {
					el.dispatchEvent(new Event("endreveal"));
					el.removeAttribute("text-reveal");
				}
			}
		});
	</script>

	<div style="background-color: lightpink; width: 100%; height: 100%;"></div>
	<div visibility="hidden">
		<span id="introtext">Hello,\nIâ€™m a mobile developer\nwith a strong passion\nfor video games\nand all other mediums\nof expression</span>
	</div>

	<a-scene light="defaultLightsEnabled: false">
		<a-assets>
			<!-- register 3d assets -->
			<a-asset-item id="smartphone" src="assets/3d/smartphone.gltf"></a-asset-item>
			<a-asset-item id="bubbleOrange" src="assets/3d/bubble_orange.gltf"></a-asset-item>
			<a-asset-item id="steeringwheel" src="assets/3d/steering_wheel.gltf"></a-asset-item>

			<!-- register images -->
			<img id="squarex32" src="assets/textures/squarex32.png"></img>

			<!-- register other assets -->
			<!-- <a-asset-item id="gidole_fnt" src="assets\font\gidole.fnt"></a-asset-item> -->

			<!-- register mixins -->
			<a-mixin id="turntable"
			animation="property: rotation; to: 0 360 0; dur: 3400; easing: linear; loop: true;" />
			<a-mixin id="appearBounce"
			animation__appear_bounce_scale="property: scale; from: 0 0 0; to: 1 1 1; dur: 1600; easing: easeOutElastic;" />

			<a-mixin id="">
		</a-assets>

		<!-- <a-box hello-world="message: Judy" position="-1 0.5 -3" rotation="0 45 0" animation="property: position; to: -1 1.5 -3; dur: 1000; easing: linear; loop: true" color="#4CC3D9"></a-box> -->
		<!-- <a-sphere position="0 1.25 -5" radius="1.25" segments-height="8" segments-radial="16" color="#EF2D5E"> -->
		<!-- </a-sphere> -->
		<!-- <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" segments-height="1" segments-radial="24" color="#FFC65D"></a-cylinder> -->
		<!-- <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane> -->
		<!-- <a-sphere color="#ECECEC"></a-sphere> -->

		<a-entity light="type: ambient;"></a-entity>
		<a-entity id="mainCamera" camera position="0 0 2">
			<a-entity cursor="rayOrigin: mouse;" raycaster="objects: [button]"></a-entity>
		</a-entity>
		<!-- <a-entity position="0 0 -0.2">
			<a-entity gltf-model="#smartphone" rotation="-45 0 0" basic-click-handler button></a-entity>
		</a-entity> -->

		<a-entity id="stepHolder" portfolio-manager="step: 0;"></a-entity>

		<!-- <a-text
			position="-2 2 -2"
			scale="1 1 1"
			font="assets\font\Gidole-Regular-msdf\Gidole-Regular-msdf.json"
			align="left"
			baseline="top"
			negate="false"
			color="#462a19"
			wrap-count="40"
			value="Hello,\nIâ€™m a mobile developer\nwith a strong passion\nfor video games\nand all other mediums\nof expression" text-reveal="characterDelay: 75;"></a-text> -->
		<!-- <a-entity
			position="0 0 0"
			particle-system="particleCount: 10000; maxParticleCount: 100; maxAge: 1; type: 2; texture: assets\textures\squarex32.png; velocityValue: 0 1 0; velocitySpread: 2 2 2; accelerationValue: 0 -1.5 0; accelerationSpread: 0 0 0; color: #FFFFFF; opacity: 1, 0; size: 0.3; blending: 1;"></a-entity> -->
		<!-- <a-entity gltf-model="#bubbleOrange" position="0 0 0" start-button button>
			<a-text
				font="assets\font\Gidole-Regular-msdf\Gidole-Regular-msdf.json"
				color="#48220d"
				align="center"
				position="0 0.02 0.08"
				scale="0.6 0.6 0.6"
				negate="false"
				value="Start"></a-text>
		</a-entity> -->
	</a-scene>
</body>

</html>